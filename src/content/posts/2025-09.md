---
date: 2025-09
tags:
  - Java
  - JDK 升级
  - 性能优化
cover: null
---

# 2025-09 JDK 1.8 升级至 21 踩坑记录

    - JDK 21 默认 GC 为 G1
    - -XX:+UseZGC 使用 ZGC，但默认是不分代的，通过 -XX:+ZGenerational 开启分代模式

## 零、前期准备

在正式升级至 JDK 21 之前可以在 JDK 1.8 下升级相关依赖包，注意若之前使用的是 1.x FastJson 那么升级到 2.x 有很多坑

::: details pom.xml
``` xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.7.18</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>

        <java.version>1.8</java.version>

        <mybatis-spring-boot-starter.version>2.3.2</mybatis-spring-boot-starter.version>
        <slf4j.version>1.7.36</slf4j.version>
        <!--更新记录：https://github.com/pagehelper/pagehelper-spring-boot/releases -->
        <!--底层 pagehelper 依赖更新记录：https://github.com/pagehelper/Mybatis-PageHelper/releases -->
        <pagehelper-spring-boot-starter.version>1.4.7</pagehelper-spring-boot-starter.version>
        <!--更新记录：https://github.com/alibaba/druid/releases -->
        <druid.version>1.2.27</druid.version>
        <!--更新记录：https://github.com/alibaba/fastjson2/releases -->
        <fastjson.version>2.0.59</fastjson.version>
        <!--更新记录：https://hutool.cn/docs/#/CHANGELOG -->
        <hutool.version>5.8.43</hutool.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-logging</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-aop</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
        </dependency>

        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter-test</artifactId>
            <version>${mybatis-spring-boot-starter.version}</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>com.alibaba.fastjson2</groupId>
            <artifactId>fastjson2</artifactId>
            <version>${fastjson.version}</version>
        </dependency>

        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>${hutool.version}</version>
        </dependency>

        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>${mybatis-spring-boot-starter.version}</version>
        </dependency>

        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>${pagehelper-spring-boot-starter.version}</version>
        </dependency>

        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>jcl-over-slf4j</artifactId>
            <version>${slf4j.version}</version>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>log4j-over-slf4j</artifactId>
            <version>${slf4j.version}</version>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>jul-to-slf4j</artifactId>
            <version>${slf4j.version}</version>
        </dependency>

        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
            <version>${druid.version}</version>
        </dependency>
    </dependencies>
</project>
```
:::

### 线上问题
::: details 不打印/写日志；No SLF4J providers were found.

``` bash
SLF4J(W): No SLF4J providers were found.
SLF4J(W): Defaulting to no-operation (NOP) logger implementation
SLF4J(W): See https://www.slf4j.org/codes.html#noProviders for further details.
SLF4J(W): Class path contains SLF4J bindings targeting slf4j-api versions 1.7.x or earlier.
SLF4J(W): Ignoring binding found at [jar:file:/C:/Users/nicha/.m2/repository/ch/qos/logback/logback-classic/1.2.12/logback-classic-1.2.12.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J(W): See https://www.slf4j.org/codes.html#ignoredBindings for an explanation.
```

问题其实就是目标版本的 slf4j api 没有被成功加载，原因如下：
- slf4j.version 这个 pom 变量会导致加载的 slf4j-api 的包版本也是 2.0.17，很莫名
- spring-boot-starter-logging 依赖了 logback 而 logback-parent 中定义了下述内容

![error_pom_01](/public/posts/2025-09/error_pom_01.png)

**错误版本 pom.xml**
``` xml
<properties>
    <java.version>1.8</java.version>
  
    <slf4j.version>2.0.17</slf4j.version>
</properties>

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-logging</artifactId>
    </dependency>
  
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>jcl-over-slf4j</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>log4j-over-slf4j</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>jul-to-slf4j</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
</dependencies>
```

**正确版本 pom.xml**
``` xml
<properties>
    <java.version>1.8</java.version>
  
    <slf4j.version>1.7.36</slf4j.version>
</properties>

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-logging</artifactId>
    </dependency>
  
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>jcl-over-slf4j</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>log4j-over-slf4j</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>jul-to-slf4j</artifactId>
        <version>${slf4j.version}</version>
    </dependency>
</dependencies>
```
:::

## 一、IDE 设置

## 二、代码改造

### JDK 版本升级相关

### SpringBoot 升级相关

### Logback 日志框架配置警告

### FastJSON 升级相关

## 三、部署配置

## 四、线上问题

::: details NoResourceFoundException
``` bash
org.springframework.web.servlet.resource.NoResourceFoundException: No static resource v2/resource/getResource.
	at org.springframework.web.servlet.resource.ResourceHttpRequestHandler.handleRequest(ResourceHttpRequestHandler.java:585)
	at org.springframework.web.servlet.mvc.HttpRequestHandlerAdapter.handle(HttpRequestHandlerAdapter.java:52)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:914)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:590)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:195)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)
```

- **Spring 5.x 及更早版本:** `setUseTrailingSlashMatch(true)` - 自动匹配带尾部斜杠的路径
- **Spring 6.0+:** `setUseTrailingSlashMatch(false)` - 不再自动匹配带尾部斜杠的路径

``` java
/**
 * Configure whether a {@link PathPattern} produced by this parser should
 * automatically match request paths with a trailing slash.
 * <p>If set to {@code true} a {@code PathPattern} without a trailing slash
 * will also match request paths with a trailing slash. If set to
 * {@code false} a {@code PathPattern} will only match request paths with
 * a trailing slash.
 * <p>The default was changed in 6.0 from {@code true} to {@code false} in
 * order to support the deprecation of the property.
 * @deprecated transparent support for trailing slashes is deprecated as of
 * 6.0 in favor of configuring explicit redirects through a proxy,
 * Servlet/web filter, or a controller.
 */
@Deprecated(since = "6.0")
public void setMatchOptionalTrailingSeparator(boolean matchOptionalTrailingSeparator) {
    this.matchOptionalTrailingSeparator = matchOptionalTrailingSeparator;
}
```
:::

::: details FastJSON 1.x 与 2.x 对于日期时间序列化行为不一致

- 详见  部门公共包（产品增长研发小组定制版）中 MarketCenter Common 的 3.0.3、3.0.5 版本描述
- LocalDateTime FastJSON 1.x 为 2025-10-20T17:15:35.065 FastJSON 2.x 为 2025-10-20 17:15:35.065。而 Spring MVC @RequesBody 默认按照 2025-10-20T17:15:35.065 规则接收

``` java
@Data
public class Params {
  private LocalDateTime payTime;
}

// server
@PostMapping("/notify")
public String notify(@RequestBody Params params) {
  return JSON.toJSONString(params);
}

// client
public static void main(String[] args) {
    JSONWriter.Context context = new JSONWriter.Context();
    context.setDateFormat("yyyy-MM-ddTHH:mm:ss");

    Params params = new Params();
    params.setPayTime(LocalDateTime.now());
    String body = JSON.toJSONString(params, context);
}
```
:::

::: details FastJSON 1.x 与 2.x 对于内部类兼容处理不一致

com.alibaba.fastjson.JSONException: create instance error, class com.ly.mc.ticket.model.vo.order.UserTicketOrderAuxiliary$TradeOrderResponseVO

![code_diff_fastjson_01](/public/posts/2025-09/code_diff_fastjson_01.png)
:::

::: details Apache HttpClient 5.x 默认中文不编码会导致按 UTF-8 接收乱码

不能直接拼接好字符串的 URL，而需要通过 URIBuilder 的方式构建 URI，如下图：
![code_diff_httpclient_01](/public/posts/2025-09/code_diff_httpclient_01.png)
:::

::: details 部署构建一直卡着不动
- 安装和更新必要软件时一直下载不下来（后续有时间了把这个步骤预先打在镜像里）
- 阿里云的源有时候抽风，可以尝试换成清华的源

**old**
``` DOCKERFILE
# 更新源并安装所需软件
RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y iptables iproute2 && \
    rm -rf /var/lib/apt/lists/*
```
**new**
``` DOCKERFILE
# 更新源并安装所需软件
# 更新源并安装所需软件
RUN sed -i 's/archive.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list && \
    sed -i 's/security.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y iptables iproute2 && \
    rm -rf /var/lib/apt/lists/*
```
:::

::: details Name for argument of type [java.lang.String] not specified, and parameter name information not available via reflection. Ensure that the compiler uses the '-parameters' flag.

Spring 框架 6.1 版本开始不再尝试通过解析字节码来推断参数名称，需要手动增加注解并标注名称，详见：[Spring Framework 6.1 Release Notes · spring-projects/spring-framework Wiki](https://github.com/spring-projects/spring-framework/wiki/Spring-Framework-6.1-Release-Notes#parameter-name-retention)

**请求报文**
``` http
POST http://localhost:8149/greatorder/api/test/refund
Content-Type: application/x-www-form-urlencoded

projectSerialId=111_074b3c73d6764c3babd158d0d018944e&payTradeNo=DWU691A8F199P9JEVW53Y&notifyUrl=%22https%3A%2F%2Fwx.17u.cn%2Fallticket%2Fapi%2Fordernotify%22&memberId=3481195877&amt=9.9&projectCode=1520200320xsjlk&signKey=DA10F43CE0C15C3CA8C058D02B7BE9FC&doCashierGateWayUrl=&pushFinanceType=0
```

**优化前**
``` java
@RequestMapping("/refund")
public BaseResponse<Void> refund(String projectSerialId,
                                 HashMap<String, Object> payProjectInfo) {
    return cashierManager.refundOrder(projectSerialId, payProjectInfo);
}
```

**优化后**
``` java
@RequestMapping("/refund")
public BaseResponse<Void> refund(@RequestParam("projectSerialId") String projectSerialId,
                                 @RequestParam(value = "payProjectInfo", required = false) HashMap<String, Object> payProjectInfo) {
    return cashierManager.refundOrder(projectSerialId, payProjectInfo);
}
```
:::